lets check first the lambda functionality in the backend and report your findings to make : 

When a user clicks "Create" with a subdomain name, the Lambda function will provision a complete isolated tenant environment including database schema, ECS services, load balancer routing, and DNS.

## ğŸ—ï¸ Infrastructure Components (Existing)
- **ECS Cluster:** `moamalat-cluster` (ACTIVE)
- **ALB:** `moamalat-alb` (internet-facing)
- **Route53:** `moamalat-pro.com` hosted zone
- **Template Service:** `test-moamalat-api:2` (for cloning)
- **Frontend Template:** `moamalat-frontend:2`

## ğŸ“Š DynamoDB Tables
### `tenants` Table Schema:
```json
{
  "tenant_id": "UUID (Primary Key)",
  "subdomain": "String (GSI)",
  "plan": "free-trial | professional",
  "admin_email": "String",
  "status": "provisioning | database_ready | backend_deploying | frontend_deploying | active | failed",
  "created_at": "ISO Timestamp",
  "activated_at": "ISO Timestamp",
  "provisioning_id": "UUID",
  "cluster_name": "moamalat-cluster",
  "alb_arn": "ALB ARN",
  "url": "https://{subdomain}.moamalat-pro.com",
  "api_url": "https://{subdomain}.moamalat-pro.com/moamalat-api",
  "backend_service_arn": "ECS Service ARN",
  "frontend_service_arn": "ECS Service ARN",
  "target_group_arn": "ALB Target Group ARN",
  "task_definition_arn": "ECS Task Definition ARN"
}
```

ğŸ“‹ Provisioning Steps
Phase 1: Validation & Record Creation
Step 1: Input Validation
â”œâ”€â”€ Validate subdomain format:
â”‚   â”œâ”€â”€ Lowercase only
â”‚   â”œâ”€â”€ Alphanumeric + hyphens allowed
â”‚   â”œâ”€â”€ Length: 3-20 characters
â”‚   â”œâ”€â”€ No special characters
â”‚   â””â”€â”€ Must start/end with alphanumeric
â”œâ”€â”€ Check subdomain availability in DynamoDB
â”‚   â””â”€â”€ If exists â†’ Return error: "Subdomain already exists"
â”œâ”€â”€ Validate plan type (free-trial / professional)
â””â”€â”€ Generate unique tenant_id (UUID)
Step 2: Record Tenant in DynamoDB
â”œâ”€â”€ Create record in tenants table:
â”‚   â”œâ”€â”€ tenant_id: <generated UUID>
â”‚   â”œâ”€â”€ subdomain: <user input>
â”‚   â”œâ”€â”€ plan: <selected plan>
â”‚   â”œâ”€â”€ admin_email: <from Cognito>
â”‚   â”œâ”€â”€ status: "provisioning"
â”‚   â”œâ”€â”€ created_at: <timestamp>
â”‚   â”œâ”€â”€ provisioning_id: <for status tracking>
â”‚   â”œâ”€â”€ cluster_name: "moamalat-cluster"
â”‚   â””â”€â”€ alb_arn: "arn:aws:elasticloadbalancing:us-east-1:339712855370:loadbalancer/app/moamalat-alb/25303afaeb8924d6"
â””â”€â”€ Return provisioning_id to frontend for polling

Phase 2: Database Setup
Step 3: Create Database Schema
â”œâ”€â”€ Get DB credentials from Secrets Manager
â”‚   â””â”€â”€ Secret: moamalat-secrets
â”œâ”€â”€ Connect to RDS PostgreSQL instance
â”‚   â””â”€â”€ Instance: moamalat-db
â”œâ”€â”€ Execute SQL:
â”‚   â””â”€â”€ CREATE SCHEMA IF NOT EXISTS "{subdomain}"
â”œâ”€â”€ Schema is created EMPTY
â”‚   â””â”€â”€ Hibernate will auto-create tables on ECS startup
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "database_ready"

Phase 3: ECS Task Definition
Step 4: Create Task Definition (Copy & Modify)
â”œâ”€â”€ Describe existing task definition:
â”‚   â””â”€â”€ Source: test-moamalat-api:2 (template)
â”œâ”€â”€ Create NEW task definition:
â”‚   â””â”€â”€ Name: moamalat-{subdomain}
â”œâ”€â”€ Modify environment variables:
â”‚   â”œâ”€â”€ DB_NAME = {subdomain}
â”‚   â”œâ”€â”€ spring.jpa.hibernate.ddl-auto = create
â”‚   â”œâ”€â”€ LDAP_HOST = <EC2 OpenLDAP IP>
â”‚   â””â”€â”€ S3_BUCKET = moamalat-saas-documents-339712855370
â”œâ”€â”€ Keep unchanged:
â”‚   â”œâ”€â”€ CPU/Memory allocation
â”‚   â”œâ”€â”€ IAM task role
â”‚   â”œâ”€â”€ Log configuration
â”‚   â””â”€â”€ Container image
â””â”€â”€ Register new task definition

Phase 4: Load Balancer Configuration
Step 5: Create Target Group
â”œâ”€â”€ Create target group:
â”‚   â”œâ”€â”€ Name: moamalat-{subdomain}-tg
â”‚   â”œâ”€â”€ Target type: IP
â”‚   â”œâ”€â”€ Protocol: HTTP
â”‚   â”œâ”€â”€ Port: 8080
â”‚   â”œâ”€â”€ VPC: Same as existing services
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "target_group_created"
Step 6: Create ALB Listener Rule
â”œâ”€â”€ Get existing HTTPS listener (port 443)
â”œâ”€â”€ Create new rule:
â”‚   â”œâ”€â”€ Condition: Host header = {subdomain}.moamalat-pro.com
â”‚   â”œâ”€â”€ Action: Forward to moamalat-{subdomain}-tg
â”‚   â””â”€â”€ Priority: Auto-assign (next available)
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "alb_configured"

Phase 5: DNS Configuration
Step 7: Create Route53 DNS Record
â”œâ”€â”€ Hosted zone: moamalat-pro.com
â”œâ”€â”€ Create/Update record:
â”‚   â”œâ”€â”€ Type: A (Alias)
â”‚   â”œâ”€â”€ Name: {subdomain}.moamalat-pro.com
â”‚   â”œâ”€â”€ Target: ALB DNS name
â”‚   â””â”€â”€ TTL: 300 seconds
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "dns_configured"

Phase 6: ECS Service Deployment
Step 8: Create & Launch ECS Service (Backend)
â”œâ”€â”€ Create ECS service:
â”‚   â”œâ”€â”€ Service name: moamalat-{subdomain}-api
â”‚   â”œâ”€â”€ Cluster: moamalat-cluster
â”‚   â”œâ”€â”€ Task definition: moamalat-{subdomain}:1
â”‚   â”œâ”€â”€ Launch type: FARGATE
â”‚   â”œâ”€â”€ Desired count: 1
â”‚   â”œâ”€â”€ Network configuration:
â”‚   â”‚   â”œâ”€â”€ Subnets: Private subnets
â”‚   â”‚   â”œâ”€â”€ Security group: Existing ECS SG
â”‚   â”‚   â””â”€â”€ Assign public IP: false
â”‚   â””â”€â”€ Load balancer:
â”‚       â”œâ”€â”€ Target group: moamalat-{subdomain}-tg
â”‚       â”œâ”€â”€ Container name: moamalat-api
â”‚       â””â”€â”€ Container port: 8080
â”œâ”€â”€ Wait for service to stabilize
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "backend_deploying"
Step 9: Monitor Backend Startup
â”œâ”€â”€ Poll ECS task logs (CloudWatch)
â”œâ”€â”€ Scan for success message:
â”‚   â””â”€â”€ "Tomcat started on port(s): 8081 (http) with context path '/moamalat-api'"
â”œâ”€â”€ Retry configuration:
â”‚   â”œâ”€â”€ Max attempts: 20
â”‚   â”œâ”€â”€ Interval: 30 seconds
â”‚   â””â”€â”€ Timeout: 10 minutes
â”œâ”€â”€ On success:
â”‚   â””â”€â”€ Proceed to frontend deployment
â””â”€â”€ On failure:
    â”œâ”€â”€ Update DynamoDB: status: "backend_failed"
    â””â”€â”€ Return error to user
Step 10: Create & Launch ECS Service (Frontend)
â”œâ”€â”€ Describe existing frontend task definition:
â”‚   â””â”€â”€ Source: moamalat-frontend:2
â”œâ”€â”€ Create NEW task definition:
â”‚   â”œâ”€â”€ Name: moamalat-{subdomain}-frontend
â”‚   â””â”€â”€ Modify environment variables:
â”‚       â””â”€â”€ API_URL = https://{subdomain}.moamalat-pro.com/moamalat-api
â”œâ”€â”€ Create ECS service:
â”‚   â”œâ”€â”€ Service name: moamalat-{subdomain}-frontend
â”‚   â”œâ”€â”€ Cluster: moamalat-cluster
â”‚   â”œâ”€â”€ Same network/security as backend
â”‚   â””â”€â”€ Same IAM roles
â””â”€â”€ Update DynamoDB:
    â””â”€â”€ status: "frontend_deploying"

Phase 7: Health Check & Finalization
Step 11: Health Check & Validation
â”œâ”€â”€ Wait for ECS tasks: RUNNING
â”‚   â””â”€â”€ Max wait: 5 minutes
â”œâ”€â”€ Check target group health: HEALTHY
â”‚   â”œâ”€â”€ Retry: Up to 10 times
â”‚   â””â”€â”€ Interval: 30 seconds
â”œâ”€â”€ Verify endpoint accessibility:
â”‚   â””â”€â”€ GET https://{subdomain}.moamalat-pro.com/moamalat-api/swagger-ui/index.html
â”œâ”€â”€ On success:
â”‚   â””â”€â”€ Update DynamoDB: status: "ready"
â””â”€â”€ On failure:
    â”œâ”€â”€ Update DynamoDB: status: "failed"
    â”œâ”€â”€ Store error details
    â””â”€â”€ Trigger cleanup (optional)
Step 12: Return Result & Notify User
â”œâ”€â”€ Update DynamoDB final record:
â”‚   â”œâ”€â”€ status: "active"
â”‚   â”œâ”€â”€ url: https://{subdomain}.moamalat-pro.com
â”‚   â”œâ”€â”€ api_url: https://{subdomain}.moamalat-pro.com/moamalat-api
â”‚   â”œâ”€â”€ activated_at: <timestamp>
â”‚   â””â”€â”€ admin_credentials_sent: true
â”œâ”€â”€ update welcome email :
â”‚   â”œâ”€â”€ Instance URL
â”‚   â”œâ”€â”€ Admin credentials
â”‚   â””â”€â”€ Getting started guide
â””â”€â”€ Return to frontend:
    {
      "success": true,
      "tenantId": "{subdomain}",
      "url": "https://{subdomain}.moamalat-pro.com",
      "adminUsername": "admin",
      "password": "admin123"
      "message": "Your MOAMALAT instance is ready!"
    }